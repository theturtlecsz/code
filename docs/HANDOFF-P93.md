# P93 Session Handoff: /speckit.vision Front Door

## Session Lineage
P89 (Data Model) → P90 (TASK_BRIEF + Tier-2) → P91 (Conflict Detection + Gate + Command) → P92 (Block + Cache + Plan) → **P93** (Vision Q&A)

## Context

P91-P92 built the enforcement foundation:
- `GateMode::Block` aborts pipeline when constitution incomplete
- `invalidate_tier2_by_constitution()` drops stale cache on constitution change
- `/speckit.constitution` view/add/sync commands
- `/speckit.plan-pipeline` for planning-only execution with gate respect

**What's missing**: A guided way to populate constitution content. Currently users must manually craft goals/non-goals/principles. `/speckit.vision` fills this gap.

## P93 Scope (4 Tasks)

### Task 1: Implement `/speckit.vision` Command Structure
**Files**: `codex-rs/tui/src/chatwidget/spec_kit/commands/special.rs`, `command_registry.rs`

Create `SpecKitVisionCommand` with Q&A wizard flow:
- Questions to capture:
  - Target users (who is this for?)
  - Problem statement (what pain are we solving?)
  - Primary goals (3-5 success criteria)
  - Non-goals (what we explicitly won't build)
  - Key principles (architectural/design values)
- Use modal or inline Q&A (similar to `/speckit.new` pattern)
- Aliases: `speckit.vision`, `vision`

### Task 2: Map Vision Answers → Constitution Data Model
**Files**: `codex-rs/tui/src/chatwidget/spec_kit/commands/special.rs`, `codex-rs/stage0/src/overlay_db.rs`

Wire Q&A responses to constitution memories:
- Goals → `ConstitutionType::Goal` (priority 8)
- Non-goals → `ConstitutionType::NonGoal` (priority 8)
- Principles → `ConstitutionType::Principle` (priority 9)
- Call `upsert_constitution_memory()` for each item
- Call `increment_constitution_version()` after all items stored
- Trigger `invalidate_tier2_by_constitution()` for cache coherence

### Task 3: Generate and Sync `NL_VISION.md`
**Files**: `codex-rs/tui/src/chatwidget/spec_kit/commands/special.rs`

Create `NL_VISION.md` artifact:
- Aggregate all vision content (users, problem, goals, non-goals, principles)
- Write to `memory/NL_VISION.md` (NotebookLM-readable)
- Optionally update `memory/constitution.md` with Vision section
- Follow pattern from `/speckit.constitution sync`

### Task 4: Unit + Integration Tests for Vision Command
**Files**: `codex-rs/stage0/src/lib.rs` or `overlay_db.rs`, `codex-rs/tui/tests/` (if needed)

Add tests:
- Vision command creates constitution memories with correct types
- Vision command increments constitution version
- Vision command invalidates Tier 2 cache
- `NL_VISION.md` generated with expected structure

## Key APIs from P91-P92

```rust
// Constitution memory storage
pub fn upsert_constitution_memory(
    &self,
    memory_id: &str,
    constitution_type: ConstitutionType,
    content: &str,
) -> Result<()>;

// Version management
pub fn increment_constitution_version(&self, content_hash: Option<&str>) -> Result<u32>;

// Cache invalidation (P92)
pub fn invalidate_tier2_by_constitution(&self) -> Result<usize>;

// Constitution types
pub enum ConstitutionType {
    Guardrail,  // priority 10
    Principle,  // priority 9
    Goal,       // priority 8
    NonGoal,    // priority 8
}
```

## Tests

```bash
cd codex-rs && cargo test -p codex-stage0 -- --test-threads=1
~/code/build-fast.sh
```

## Out of Scope (P94)

- `/speckit.specify` constitution-aware prompts
- Eval cases for constitution enforcement
- Drift detection (`/speckit.check-alignment`)
- Spec-level version comparisons
- Auto-seeding from existing docs

## Design Notes

### Q&A Flow Pattern
Consider reusing `prd_builder_modal` pattern from `/speckit.new`:
- Define `VisionQuestion` struct with category, question, placeholder
- Modal captures all answers before processing
- Process answers into constitution memories atomically

### Memory ID Convention
Use predictable IDs for vision-created memories:
- `vision-goal-{uuid}` for goals
- `vision-nongoal-{uuid}` for non-goals
- `vision-principle-{uuid}` for principles

### NL_VISION.md Structure
```markdown
# Project Vision

_Auto-generated by /speckit.vision. Do not edit directly._

## Target Users
{target_users}

## Problem Statement
{problem_statement}

## Goals
- {goal_1}
- {goal_2}
...

## Non-Goals
- {nongoal_1}
...

## Principles
- {principle_1}
...
```

## Session Completion Criteria

- [ ] `/speckit.vision` command registered and executable
- [ ] Q&A wizard captures target users, problem, goals, non-goals, principles
- [ ] Answers stored as constitution memories with correct types
- [ ] Constitution version incremented after vision capture
- [ ] Tier 2 cache invalidated on vision changes
- [ ] `NL_VISION.md` generated in `memory/` directory
- [ ] Unit tests for vision → constitution mapping
- [ ] 162+ Stage0 tests still passing
