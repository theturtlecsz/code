 ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
 │                                                                                                                                       Code  •  Model: GPT-5-Codex  •  Reasoning: medium  •  Directory: ~/code/codex-rs                                                                                                                                       │
 └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
 ┌ Agents ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
 │ • gemini-25-flash (done), code (done), claude-haiku-45 (done)                                                                                                                                                                                                                                                                           Ctrl+A open terminal │
 └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
   30min), empty result detection (AR-3) | ✅ Implemented |\n| **Consensus corruption** | SQLite ACID, file locking (ARCH-007), fallback to filesystem | ✅ Implemented |\n| **Quality gate failures** | Native orchestrator (eliminates LLM plumbing), escalation to human modal | ✅ Implemented |\n| **Evidence growth** | 25 MB soft limit, archival
   automation (MAINT-4), monitoring via `/spec-evidence-stats` | ✅ Implemented |\n| **Async/sync impedance** | Handle::block_on() pattern, 8.7ms MCP latency (acceptable) | ✅ Documented |\n| **Cost runaway** | Tiered strategy (Tier 0-4), native quality commands ($0), agent retry guidance | ✅ Validated |\n\n---\n\n## 2. VALIDATION STRATEGY: TEST
   MATRIX\n\n### 2.1 Success Path Tests (12 scenarios)\n\n**Goal**: Verify nominal operation across all pipeline stages and model tiers\n\n| Test ID | Scenario | Coverage | Pass Criteria |\n|---------|----------|----------|---------------|\n| **VP-01** | Full 6-stage pipeline (Tier 4) | All stages, dynamic agent routing | ✅ All stages complete,
   >95% cost prediction accuracy |\n| **VP-02** | Tier 0 quality command (native) | `/speckit.clarify`, `/speckit.analyze`, `/speckit.checklist` | ✅ Execute <1s, return valid JSON, $0 cost |\n| **VP-03** | Tier 2 single stage | `/speckit.plan` (gemini, claude, code) | ✅ 3 agents spawn, consensus reached, >90% agreement |\n| **VP-04** | Tier 3
   implement stage | `/speckit.implement` (gpt_codex + validators) | ✅ Code generated, tests run, linting passes |\n| **VP-05** | MCP consensus success | Agent → MCP call_tool → local-memory search → synthesis | ✅ All artifacts persisted, <10s latency |\n| **VP-06** | SQLite consensus DB | Artifacts stored, indexed, queryable | ✅ <5ms query
   latency, schema validation |\n| **VP-07** | Quality gate unanimous | All 3 agents agree on issue → auto-resolve | ✅ Auto-fixed within 2s, confidence=High |\n| **VP-08** | Quality gate majority | 2/3 agents agree → GPT-5 validation | ✅ GPT-5 called, resolution applied or escalated |\n| **VP-09** | Evidence persistence | Files written, locked,
   readable across stages | ✅ Zero corruption, proper cleanup after unlock |\n| **VP-10** | Telemetry schema v1 | Guardrail emits valid JSON per spec | ✅ All 6 fields present, nested structures valid |\n| **VP-11** | Cost tracking | Tier routing matches predicted cost ±5% | ✅ Actual vs predicted within threshold |\n| **VP-12** | Documentation
   integration | All 6 markdown outputs created with proper format | ✅ Valid markdown, TOC generated, links valid |\n\n---\n\n### 2.2 Degradation Tests (10 scenarios)\n\n**Goal**: Verify graceful handling when one or more agents fails\n\n| Test ID | Scenario | Trigger | Expected Outcome |\n|---------|----------|---------|-----------------|\n|
   **VD-01** | Single agent empty output | Gemini returns 1-byte response | 2/3 consensus valid, use Claude+Code |\n| **VD-02** | Single agent timeout | Gemini exceeds 30min total timeout | Retry (AR-1), max 3 attempts, abort if all fail |\n| **VD-03** | Malformed JSON output | Claude returns non-JSON | Retry with schema guidance (AR-4), parse error
   handling |\n| **VD-04** | MCP unavailable | local-memory server unreachable | Fallback: search evidence filesystem, continue |\n| **VD-05** | SQLite DB corruption | consensus_artifacts.db lock/corruption | Fallback: local-memory MCP, retry writes |\n| **VD-06** | Quality gate escalation | Split decision (no consensus) | Escalate to human modal,
   record decision, continue |\n| **VD-07** | Evidence file lock contention | Concurrent writes to same file | File locking (fs2) prevents corruption, queue writes |\n| **VD-08** | Agent retry exhaustion | 3 retries all fail | Log failure, mark stage as degraded, offer skip option |\n| **VD-09** | Cost budget exceeded | Multi-agent reach >$5 per
   stage | Warn user, downgrade to cheaper agents, continue |\n| **VD-10** | Evidence quota exceeded | >25 MB per SPEC detected | Pause pipeline, trigger archival, prompt user |\n\n---\n\n### 2.3 Conflict Resolution Tests (8 scenarios)\n\n**Goal**: Verify handling of agent disagreements and arbiter behavior\n\n| Test ID | Scenario | Agents | Arbiter
   Decision | Validation |\n|---------|----------|--------|-----------------|------------|\n| **VC-01** | 2-to-1 plan disagreement | Gemini: thorough, Claude: minimal, Code: median | GPT-5 selects best, synthesizes | Decision logged, agents agree post-synthesis |\n| **VC-02** | Quality gate conflict | \"critical\" vs \"minor\" issue classification
   | Magnitude scoring, vote on resolvability | Issue tracked with confidence<High |\n| **VC-03** | Task decomposition split | Gemini: 5 tasks, Claude: 8 tasks, Code: 6 tasks | Merge unique tasks, deduplicate, order | All tasks present, zero orphans |\n| **VC-04** | Test strategy divergence | Implement: needs edge case tests, Validate: baseline
   only | Consensus: include edge cases | Test strategy reflects 2/3 majority |\n| **VC-05** | Compliance audit conflict | Audit: \"passes all\", Code: \"needs security review\" | GPT-5 arbitrates, requires human if tied | Audit result tracks minority opinion |\n| **VC-06** | Evidence interpretation | Different agents parse output differently
   | Consensus synthesizes, stores both interpretations | Evidence includes dissent notes |\n| **VC-07** | Cost efficiency vs quality | Cheap agent vs expensive agent recommendations | User preference applied (config-driven) | Final choice logged with rationale |\n| **VC-08** | Retry guidance divergence | Agents disagree on fix strategy | GPT-5
   selects, retry with selected guidance | Retry succeeds with <2 attempts average |\n\n---\n\n### 2.4 Outage & Recovery Tests (7 scenarios)\n\n**Goal**: Verify system resilience when external services fail\n\n| Test ID | Scenario | Failure | Recovery Time | Validation |\n|---------|----------|---------|----------------|------------|\n| **VR-01**
   | MCP server restart | local-memory unavailable 30s | Fallback to filesystem, resume <5s after recovery | Zero data loss |\n| **VR-02** | SQLite transaction rollback | DB write fails midway | Transaction rolls back, retry on next call | Consistency maintained |\n| **VR-03** | Agent API outage | OpenAI/Gemini API down 60s | Queue requests,
   timeout after 30min total | User alerted, offer continue w/o agent |\n| **VR-04** | Disk space exhausted | Evidence directory full | Trigger cleanup, archive >30d artifacts | Pipeline resumes after cleanup |\n| **VR-05** | Git commit failure | `.git` directory permissions broken | Log error, skip commit stage, continue | Evidence saved, manual
   commit needed |\n| **VR-06** | Evidence directory missing | `~/.code/evidence/` deleted mid-run | Recreate directory, resume from last checkpoint | Checkpoint recovery works |\n| **VR-07** | Network flake | Intermittent connection loss | Retry (AR-2), exponential backoff | Self-healing, zero manual intervention |\n\n---\n\n### 2.5 Evidence
   & Artifact Tests (6 scenarios)\n\n**Goal**: Verify evidence lifecycle, retention, and telemetry integrity\n\n| Test ID | Scenario | Validation | Expected |\n|---------|----------|-----------|----------|\n| **VE-01** | Evidence footprint tracking | Each SPEC < 25 MB soft limit | All active SPECs pass check |\n| **VE-02** | Consensus artifact
   persistence | Each agent output stored in SQLite + local-memory | Dual-write success, reconciliation on collision |\n| **VE-03** | Telemetry schema compliance | Every guardrail emit has: command, specId, sessionId, timestamp, schemaVersion, artifacts[] | 100% schema validation pass rate |\n| **VE-04** | Evidence cleanup automation | Archives >30d
   artifacts, purges >180d with `--enable-purge` | No manual intervention needed |\n| **VE-05** | Local-memory artifact tagging | Consensus artifacts tagged with spec:ID, stage:, agent: | Query by tag succeeds, ~50-100 memories per SPEC |\n| **VE-06** | Evidence reconstruction | Can rebuild consensus synthesis from raw artifacts | Reconstruction
   matches original, test idempotence |\n\n---\n\n### 2.6 Regression Tests (5 scenarios)\n\n**Goal**: Catch regressions from prior fixes (SPEC-KIT-068, 069, 070)\n\n| Test ID | Prior Fix | Regression Check | Expected |\n|---------|-----------|------------------|----------|\n| **VX-01** | SPEC-KIT-068 (Quality Gates) | Async broker doesn't panic,
   gates resolve <2s | No tokio panics, resolution rate ≥70% |\n| **VX-02** | SPEC-KIT-069 (Validate Orchestration) | Single-flight guard prevents duplicate dispatch | run_id prevents >1 concurrent validation per SPEC |\n| **VX-03** | SPEC-KIT-070 (Cost Optimization) | Native quality commands don't spawn agents | `/speckit.clarify` cost = $0, <1s
   execution |\n| **VX-04** | SPEC-KIT-072 (SQLite DB) | Consensus artifacts persisted AND queryable | Dual-write success, query latency <5ms |\n| **VX-05** | AR-1/2/3/4 (Retry Logic) | Retry guidance injected, empty detection works | Failed agents retried, AR-3 triggers on 1-byte output |\n\n---\n\n## 3. ACCEPTANCE CRITERIA & TELEMETRY\n\n###
   3.1 Per-Agent Pass/Fail Signals\n\n**Requirement**: Each agent's execution produces definitive pass/fail signal\n\n```json\n{\n  \"agent_name\": \"gemini\",\n  \"stage\": \"plan\",\n  \"status\": \"passed|failed|timeout|degraded\",\n  \"retry_count\": 0,\n  \"output_tokens\": 1245,\n  \"latency_ms\": 8723,\n  \"confidence_score\": 0.95,
   \n  \"error\": null\n}\n```\n\n**Acceptance Criteria**:\n- ✅ All 5 agents report status per execution\n- ✅ Retry count accurate (≤3)\n- ✅ Latency within 30min timeout\n- ✅ Confidence score 0.0-1.0\n- ✅ Error object populated on failure\n\n---\n\n### 3.2 Consensus Quality Metrics\n\n**Requirement**: Consensus synthesis includes agreement/
   conflict signals\n\n```json\n{\n  \"stage\": \"plan\",\n  \"consensus_ok\": true,\n  \"degraded\": false,\n  \"agreement_pct\": 100,\n  \"agents_present\": 3,\n  \"agents_missing\": 0,\n  \"conflicts\": [],\n  \"quorum_type\": \"unanimous|majority|minority\",\n  \"synthesis_confidence\": \"high|medium|low\"\n}\n```\n\n**Acceptance Criteria**:\n-
   ✅ `consensus_ok` true when ≥2/3 agents agree\n- ✅ `degraded` true when <2/3 agents present\n- ✅ `agreement_pct` accurate (unanimous=100%, 2/3≈67%, 1/3≈33%)\n- ✅ `conflicts[]` array includes dissenting opinions\n- ✅ `quorum_type` matches actual agreement distribution\n\n---\n\n### 3.3 Evidence Retention & Footprint\n\n**Requirement**: Evidence
   stays within policy limits, lifecycle tracked\n\n```bash\n# Run post-validation\n/spec-evidence-stats --spec SPEC-KIT-900\n\n# Output should show:\n# SPEC-KIT-900: 18.5 MB (within 25 MB limit) ✓\n# Artifacts: 156 consensus files + 42 telemetry\n# Retention: 30-day unlock, 180-day purge\n# Status: COMPLIANT\n```\n\n**Acceptance Criteria**:\n- ✅
   All SPECs < 25 MB (soft limit)\n- ✅ Artifact counts match expected (7 stages × N agents)\n- ✅ Cleanup automation removes >30d artifacts\n- ✅ No manual intervention needed\n\n---\n\n### 3.4 Local-Memory Artifact Tagging Compliance\n\n**Requirement**: Consensus artifacts properly tagged for discoverability\n\n```bash\nlm search \"consensus plan SPEC-KIT-900\" --domain spec-kit --tags \"spec:SPEC-KIT-900,stage:plan,type:consensus\" --limit 20 --use_ai\n
   # Should return: All plan consensus artifacts with proper tags\n```\n\n**Acceptance Criteria**:\n- ✅ All consensus artifacts tagged with `spec:ID`\n- ✅ Tags use namespaced format (spec:, stage:, agent:,
   type:)\n- ✅ Query by tag succeeds\n- ✅ ~50-100 memories per active SPEC\n- ✅ Importance scores calibrated (8-9 for synthesis, 6-7 for raw artifacts)\n\n---\n\n### 3.5 Retry Logic Metrics\n\n**Requirement**: AR-2/3/4 retry logic functions correctly and is measurable\n\n```json\n{\n  \"stage\": \"implement\",\n  \"agent\": \"gpt_codex\",
   \n  \"initial_status\": \"failed\",\n  \"retries_attempted\": 2,\n  \"final_status\": \"passed\",\n  \"retry_guidance\": \"Use schema from templates/implement-template.md\",\n  \"total_latency_ms\": 45000\n}\n```\n\n**Acceptance Criteria**:\n- ✅ Retry count ≤3 (AR-2)\n- ✅ Retry guidance injected into prompt (AR-3)\n- ✅ JSON schema enforcement
   reduces malformed output ≥80% (AR-4)\n- ✅ Empty result detection triggers retry (AR-3)\n- ✅ Total latency well-below 30min timeout\n\n---\n\n### 3.6 Quality Gate Metrics\n\n**Requirement**: Quality gates track resolution rates and escalations\n\n```json\n{\n  \"checkpoint\": \"PrePlanning\",\n  \"issues_found\": 3,\n  \"auto_resolved\": 2,
   \n  \"escalated_to_gpt5\": 1,\n  \"escalated_to_human\": 0,\n  \"auto_resolution_pct\": 66,\n  \"avg_resolution_time_ms\": 1200\n}\n```\n\n**Acceptance Criteria**:\n- ✅ Auto-resolution rate ≥70% (target: 75%)\n- ✅ Escalation rate ≤20% (target: <15%)\n- ✅ Human escalation triggers modal, user decides\n- ✅ Resolution time <2s per issue\n-
   ✅ Issue magnitude classification (Critical/Important/Minor) consistent\n\n---\n\n## 4. AUTOMATION PLAN: IMPLEMENTATION ROADMAP\n\n### Phase 1: Test Infrastructure Hardening (Week 1-2)\n\n**Goal**: Ensure all test fixtures, mocks, and utilities work reliably\n\n**Tasks**:\n\n1. **Verify MockMcpManager fixtures**\n   - Load all 20 consensus
   artifact files\n   - Validate JSON schema\n   - Check fixture naming consistency\n   - Ensure proper error handling on missing fixtures\n\n2. **Validate IntegrationTestContext**\n   - Create tempdir isolation for each test\n   - Verify evidence directory creation\n   - Test cleanup on completion\n   - Check file permissions handling\n\n3. **Test
   StateBuilder fluency**\n   - Build complex states with multiple phases\n   - Verify state transitions are valid\n   - Test rollback scenarios\n   - Ensure builder produces valid SpecAutoState\n\n4. **Implement MockSpecKitContext completeness**\n   - Mock all SpecKitContext trait methods\n   - Add async execution handlers\n   - Implement fake
   event channel\n   - Add call history tracking\n\n**Deliverables**:\n- ✅ All fixtures validated (20 files, 100% loadable)\n- ✅ MockMcpManager >95% fixture hit rate in tests\n- ✅ IntegrationTestContext <50ms overhead per test\n- ✅ 100% trait implementation in mocks\n\n---\n\n### Phase 2: Success Path Validation (Week 2-3)\n\n**Goal**: Verify
   all nominal operation scenarios (VP-01 through VP-12)\n\n**Test Implementation**:\n\n```rust\n// Example: VP-01 Full pipeline test\n#[tokio::test]\nasync fn test_full_pipeline_tier4_dynamic_routing() {\n    let context = IntegrationTestContext::new(\"SPEC-KIT-VALIDATE-001\")?;\n    let mut handler = SpecKitHandler::new(context.spec_kit_context());
   \n\n    // Trigger /speckit.auto\n    handler.handle_spec_auto(\"SPEC-KIT-VALIDATE-001\").await?;\n\n    // Verify all 6 stages complete\n    let state = handler.get_current_state();\n    assert!(state.plan_complete);\n    assert!(state.tasks_complete);\n    assert!(state.implement_complete);\n    assert!(state.validate_complete);\n    assert!
   (state.audit_complete);\n    assert!(state.unlock_complete);\n\n    // Verify cost prediction\n    let cost = handler.get_estimated_cost();\n    assert!(cost.actual >= cost.predicted * 0.95); // Within 5%\n    assert!(cost.actual <= cost.predicted * 1.05);\n\n    // Verify evidence\n    assert!(context.evidence_dir_exists(\"consensus\"));
   \n    assert!(context.artifact_count(\"plan\") >= 3); // At least 3 agents\n}\n```\n\n**Tasks**:\n\n1. **Implement VP-01 through VP-06** (success paths)\n   - Full pipeline execution\n   - Tier-specific routing (0, 2-lite, 2, 3, 4)\n   - MCP consensus validation\n   - SQLite persistence check\n\n2. **Implement VP-07 through VP-09** (gates &
   evidence)\n   - Quality gate unanimous resolution\n   - Quality gate majority + GPT-5\n   - Evidence file integrity\n\n3. **Implement VP-10 through VP-12** (telemetry & docs)\n   - Telemetry schema validation\n   - Cost tracking accuracy\n   - Documentation generation\n\n**Deliverables**:\n- ✅ 12 success path tests passing\n- ✅ 100% nominal
   operation coverage\n- ✅ Cost prediction within 5% accuracy\n- ✅ Evidence footprint <25 MB per SPEC\n\n---\n\n### Phase 3: Degradation & Conflict Testing (Week 3-4)\n\n**Goal**: Verify graceful handling of failures and agent disagreements\n\n**Test Implementation**:\n\n```rust\n// Example: VD-01 Single agent empty output\n#[tokio::test]\nasync
   fn test_single_agent_empty_output_degrades_gracefully() {\n    let mut mock = MockMcpManager::new();\n    \n    // Configure gemini to return empty\n    mock.set_tool_response(\n        \"local-memory\",\n        \"search\",\n        Some(\"SPEC-KIT-900 plan\"),\n        MockResponse::Empty // 1-byte response\n    );\n    \n    // Other
   agents return normally\n    mock.load_fixture(\"consensus/900-plan-claude.json\")?;\n    mock.load_fixture(\"consensus/900-plan-code.json\")?;\n\n    let result = run_consensus_collection(&mock, \"plan\", 3).await;\n\n    assert!(result.is_ok());\n    assert_eq!(result.degraded, true);\n    assert_eq!(result.agents_present, 2); // Claude +
   Code\n    assert_eq!(result.consensus_ok, true); // 2/3 sufficient\n}\n\n// Example: VC-01 Plan disagreement\n#[tokio::test]\nasync fn test_plan_disagreement_arbiter_synthesis() {\n    let mut mock = MockMcpManager::new();\n    \n    // Deliberately mismatched outputs\n    mock.load_fixture(\"consensus/900-plan-gemini-thorough.json\")?;\n
   mock.load_fixture(\"consensus/900-plan-claude-minimal.json\")?;\n    mock.load_fixture(\"consensus/900-plan-code-median.json\")?;\n\n    let consensus = run_consensus_collection(&mock, \"plan\", 3).await?;\n\n    // Arbiter should synthesize\n    assert_eq!(consensus.conflicts.len(), 1);\n    assert_eq!(consensus.quorum_type, \"arbiter_decision\");
   \n    \n    // Synthesis should include both perspectives\n    let synthesis = consensus.synthesis;\n    assert!(synthesis.contains(\"thorough\") || synthesis.contains(\"comprehensive\"));\n    assert!(synthesis.contains(\"median\") || synthesis.contains(\"balanced\"));\n}\n```\n\n**Tasks**:\n\n1. **Implement VD-01 through VD-10** (degradation)\n
   - Single agent failures\n   - Timeouts and retries\n   - Malformed JSON handling\n   - MCP unavailability\n   - SQLite corruption\n\n2. **Implement VC-01 through VC-08** (conflicts)\n   - 2-to-1 disagreements\n   - Quality gate conflicts\n   - Task decomposition splits\n   - Arbiter decision validation\n\n3. **Implement VR-01 through VR-07**
   (recovery)\n   - MCP restart recovery\n   - SQLite rollback\n   - API outage handling\n   - Disk space exhaustion\n   - Network flakes\n\n**Deliverables**:\n- ✅ 25 degradation/conflict/recovery tests\n- ✅ Zero data loss in any failure scenario\n- ✅ Recovery time <5s for transient failures\n- ✅ Degraded mode maintains 2/3 quorum\n\n---\n…
   additional lines omitted…",
     "output_total_lines": 831,
     "output_file": "/home/thetu/code/codex-rs/.code/agents/5d213e52-a2ff-4198-bb38-8ff65eba2194/result.txt"
   }

 ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
 │                                                                                                                                                                                                                                                                                                                                                              │
 └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                                                                                                                                                                                                                                                                              Ctrl+R show reasoning  •  Ctrl+H help  •  72,850 tokens (73% left)
