# SPEC-945D Config Hot-Reload - Phase 1.2: JSON Schema Validation
# Session Startup Prompt (Copy-Paste Ready)

## Current Status (2025-11-14)

**SPEC**: SPEC-945D Config Hot-Reload (Configuration Management System)
**Branch**: feature/spec-945d-config-hot-reload
**Progress**: Phase 1.1 COMPLETE âœ… | Phase 1.2 READY ðŸŽ¯ | 6/32 hours complete (19%)

**Phase 1.1 Complete** (2h actual, 6h estimated):
- âœ… Layered config loading (defaults â†’ file â†’ env vars)
- âœ… 7 config structs (AppConfig, ModelConfig, QualityGateConfig, etc.)
- âœ… ConfigLoader with 12-factor app pattern
- âœ… 11 unit tests passing (36/36 total)
- âœ… Dependencies added (config, toml, dirs, serial_test)

---

## SESSION STARTUP SEQUENCE

### 1. VERIFY ENVIRONMENT

```bash
# Navigate to workspace
cd /home/thetu/code/codex-rs

# Verify branch
git branch --show-current
# Expected: feature/spec-945d-config-hot-reload

# Check git status (should show Phase 1.1 committed)
git status --short

# Verify tests pass
cargo test -p codex-spec-kit config::loader
# Expected: 11 passed

# Check build
cargo build -p codex-spec-kit
# Expected: Finished `dev` profile
```

### 2. LOAD CONTEXT FROM LOCAL-MEMORY

Query recent SPEC-945D work and configuration patterns:

```
Use mcp__local-memory__search:
- query: "SPEC-945D configuration layered merging"
- tags: ["spec:SPEC-945D"]
- limit: 5
- search_type: "semantic"

Use mcp__local-memory__search:
- query: "JSON schema validation patterns"
- domain: "spec-kit"
- limit: 3
```

Expected memories:
- Phase 1.1 milestone (ID: 13eeae65-b687-4608-9b61-62c917602c97)
- Config loader implementation details
- Related validation patterns

### 3. REVIEW REFERENCE DOCUMENTS

Key files to understand Phase 1.2:

```bash
# Implementation plan (Phase 1.2 section)
cat docs/SPEC-945D-config-hot-reload/IMPLEMENTATION-PLAN.md | grep -A50 "Phase 1.2"

# Full specification
cat docs/SPEC-945D-config-hot-reload/spec.md | grep -A30 "JSON Schema"

# Current config implementation (for integration)
ls -la spec-kit/src/config/
```

---

## PHASE 1.2: JSON SCHEMA VALIDATION (5 hours)

### Objective
Implement runtime validation of loaded configurations against JSON schemas to catch errors early and provide helpful error messages.

### Tasks

#### Task 1: Add jsonschema dependency (15 min)
**File**: `spec-kit/Cargo.toml`
```toml
[dependencies]
jsonschema = "0.18"  # Add to existing dependencies
```

**Validation**: `cargo check -p codex-spec-kit`

---

#### Task 2: Create JSON schemas (1.5 hours)
**File**: `spec-kit/src/config/schemas/` (new directory)

Create schema files:
- `app_config.schema.json` - Root AppConfig schema
- `model_config.schema.json` - ModelConfig schema
- `quality_gates.schema.json` - QualityGateConfig schema
- `cost_config.schema.json` - CostConfig schema
- `evidence_config.schema.json` - EvidenceConfig schema
- `consensus_config.schema.json` - ConsensusConfig schema

**Schema Requirements**:
- Required fields: Mark fields without `Option<>` as required
- Type constraints: Proper types (string, number, boolean, object, array)
- Value constraints:
  - `temperature`: 0.0 - 2.0
  - `consensus_threshold`: 0.0 - 1.0
  - `min_agents`: minimum 2, maximum must be >= min_agents
  - `max_agents`: maximum 10
  - Positive integers for retry counts, timeouts
- Pattern validation:
  - `model`: non-empty string
  - `endpoint`: URL format (optional)
- Nested objects: Define schemas for nested configs

**Example** (`quality_gates.schema.json`):
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "QualityGateConfig",
  "type": "object",
  "properties": {
    "enabled": {
      "type": "boolean",
      "description": "Enable quality gates"
    },
    "consensus_threshold": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0,
      "description": "Minimum consensus agreement threshold"
    },
    "min_test_coverage": {
      "type": ["number", "null"],
      "minimum": 0.0,
      "maximum": 100.0,
      "description": "Minimum test coverage percentage"
    },
    "schema_validation": {
      "type": "boolean",
      "description": "Enable schema validation"
    }
  },
  "required": ["enabled", "consensus_threshold", "schema_validation"]
}
```

**Validation**: Manual review against struct definitions in `loader.rs`

---

#### Task 3: Implement SchemaValidator (2 hours)
**File**: `spec-kit/src/config/validator.rs` (new)

```rust
use crate::config::error::{ConfigError, Result};
use crate::config::loader::AppConfig;
use jsonschema::{Draft, JSONSchema};
use serde_json::Value;

/// Schema validator for configuration
pub struct SchemaValidator {
    app_schema: JSONSchema,
}

impl SchemaValidator {
    /// Create a new validator with embedded schemas
    pub fn new() -> Result<Self> {
        // Load embedded schema at compile time
        let app_schema_str = include_str!("schemas/app_config.schema.json");
        let app_schema_value: Value = serde_json::from_str(app_schema_str)
            .map_err(|e| ConfigError::SchemaValidationError(format!("Failed to parse schema: {}", e)))?;

        let app_schema = JSONSchema::options()
            .with_draft(Draft::Draft7)
            .compile(&app_schema_value)
            .map_err(|e| ConfigError::SchemaValidationError(format!("Failed to compile schema: {}", e)))?;

        Ok(Self { app_schema })
    }

    /// Validate an AppConfig instance
    pub fn validate(&self, config: &AppConfig) -> Result<()> {
        // Serialize config to JSON Value
        let config_value = serde_json::to_value(config)?;

        // Validate against schema
        let result = self.app_schema.validate(&config_value);

        if let Err(errors) = result {
            let error_messages: Vec<String> = errors
                .map(|e| format!("{} at {}", e, e.instance_path))
                .collect();

            return Err(ConfigError::SchemaValidationError(
                format!("Validation failed:\n  - {}", error_messages.join("\n  - "))
            ));
        }

        Ok(())
    }
}

impl Default for SchemaValidator {
    fn default() -> Self {
        Self::new().expect("Failed to create schema validator")
    }
}
```

**Integration**: Update `ConfigLoader::load()` in `loader.rs`:
```rust
pub fn load(&self) -> Result<AppConfig> {
    // ... existing loading code ...
    let app_config: AppConfig = config.try_deserialize()?;

    // Validate with schema (if enabled in quality_gates)
    if app_config.quality_gates.schema_validation {
        let validator = SchemaValidator::new()?;
        validator.validate(&app_config)?;
    }

    Ok(app_config)
}
```

**File Updates**:
- `spec-kit/src/config/mod.rs`: Add `pub mod validator;`
- `spec-kit/src/config/mod.rs`: Re-export `pub use validator::SchemaValidator;`

---

#### Task 4: Write validation tests (1 hour)
**File**: `spec-kit/src/config/validator.rs` (add `#[cfg(test)] mod tests`)

**Test Cases** (10-12 tests):

1. **test_valid_config** - Default config passes validation
2. **test_invalid_consensus_threshold_high** - threshold > 1.0 fails
3. **test_invalid_consensus_threshold_low** - threshold < 0.0 fails
4. **test_invalid_temperature** - temperature > 2.0 fails
5. **test_invalid_min_agents** - min_agents < 2 fails
6. **test_invalid_max_agents_order** - max_agents < min_agents fails
7. **test_missing_required_field** - Missing required field fails
8. **test_invalid_type** - Wrong type (string for number) fails
9. **test_optional_fields** - Config with optional fields = None passes
10. **test_nested_validation** - Invalid nested ModelConfig fails
11. **test_schema_disabled** - Validation skipped when schema_validation = false
12. **test_multiple_errors** - Multiple validation errors reported together

**Example Test**:
```rust
#[test]
fn test_invalid_consensus_threshold_high() {
    let mut config = AppConfig::default();
    config.quality_gates.consensus_threshold = 1.5;

    let validator = SchemaValidator::new().expect("Failed to create validator");
    let result = validator.validate(&config);

    assert!(result.is_err());
    let err = result.unwrap_err();
    assert!(matches!(err, ConfigError::SchemaValidationError(_)));
    assert!(err.to_string().contains("consensus_threshold"));
}
```

**Validation**: `cargo test -p codex-spec-kit config::validator`

---

#### Task 5: Integration testing (30 min)
**File**: `spec-kit/src/config/loader.rs` (add tests to existing `mod tests`)

**Integration Tests** (3-5 tests):

1. **test_load_with_invalid_config_file** - TOML with invalid values caught
2. **test_load_with_schema_validation_disabled** - Invalid config loads when validation off
3. **test_env_override_triggers_validation** - Env var override validated
4. **test_validation_error_message_quality** - Error messages are helpful

**Example**:
```rust
#[test]
#[serial]
fn test_load_with_invalid_config_file() {
    let toml_content = r#"
[quality_gates]
enabled = true
consensus_threshold = 1.5  # Invalid: > 1.0
"#;

    let temp_dir = tempfile::tempdir().expect("Failed to create temp dir");
    let config_path = temp_dir.path().join("invalid_config.toml");
    std::fs::write(&config_path, toml_content).expect("Failed to write");

    let loader = ConfigLoader::new().with_file(&config_path);
    let result = loader.load();

    assert!(result.is_err());
    let err = result.unwrap_err();
    assert!(matches!(err, ConfigError::SchemaValidationError(_)));
    assert!(err.to_string().contains("consensus_threshold"));
}
```

**Validation**: `cargo test -p codex-spec-kit config::loader::test_load_with_invalid`

---

### SUCCESS CRITERIA

Phase 1.2 is complete when:

- âœ… jsonschema dependency added and building
- âœ… 6 JSON schema files created in `spec-kit/src/config/schemas/`
- âœ… SchemaValidator implemented with helpful error messages
- âœ… ConfigLoader integrates validation (respects schema_validation flag)
- âœ… 10-12 validator tests pass
- âœ… 3-5 integration tests pass
- âœ… Total tests: 50-55 passing (36 current + 14-17 new)
- âœ… `cargo build -p codex-spec-kit` succeeds
- âœ… `cargo clippy -p codex-spec-kit` has no errors in config module
- âœ… `cargo fmt --all` applied

**Test Command**:
```bash
# All config tests
cargo test -p codex-spec-kit config:: --lib

# Should show ~50-55 tests passing
```

---

### REFERENCE FILES

**Specification**: `docs/SPEC-945D-config-hot-reload/spec.md`
**Implementation Plan**: `docs/SPEC-945D-config-hot-reload/IMPLEMENTATION-PLAN.md`
**Phase 1.1 Code**: `spec-kit/src/config/loader.rs` (struct definitions, lines 10-230)

**Prior Art**:
- SPEC-945C retry logic: `spec-kit/src/retry/` (error handling patterns)
- JSON usage: `serde_json` already in use throughout codebase

---

### TROUBLESHOOTING

**If schemas don't load**:
- Verify `include_str!` path is relative to `validator.rs`
- Check schema JSON is valid: `jq . schemas/app_config.schema.json`

**If validation is too strict**:
- Review `Option<>` fields - should allow null in schema
- Check `required` array matches non-optional fields

**If tests fail**:
- Run serially for env var tests: `cargo test -- --test-threads=1`
- Check test isolation with `#[serial]` attribute

---

### ESTIMATED TIME

- Task 1 (Dependency): 15 min
- Task 2 (Schemas): 1.5 hours
- Task 3 (Validator): 2 hours
- Task 4 (Validator tests): 1 hour
- Task 5 (Integration tests): 30 min

**Total**: 5 hours
**Phase 1.1 actual**: 2 hours (vs 6h estimate)
**Adjustment**: May complete in 3-4 hours if similar efficiency

---

### SESSION END CHECKLIST

Before ending session:

- [ ] Store milestone to local-memory (importance â‰¥8)
- [ ] Update NEXT-SESSION-PROMPT.txt with Phase 1.3 details
- [ ] Commit Phase 1.2 work with conventional commit
- [ ] Update this prompt's "Current Status" section
- [ ] Note any blockers or discoveries

---

## ðŸŽ¯ NEXT ITEM TO WORK ON

**Start Here**: Task 1 - Add jsonschema dependency

```bash
# 1. Verify environment
cd /home/thetu/code/codex-rs
git branch --show-current

# 2. Load memories (use mcp__local-memory__search as shown above)

# 3. Add dependency
# Edit spec-kit/Cargo.toml, add jsonschema = "0.18"

# 4. Verify
cargo check -p codex-spec-kit

# 5. Proceed to Task 2 (Create schemas)
```

**Success Signal**: `cargo check` completes without errors, jsonschema compiles

**Then**: Create `spec-kit/src/config/schemas/` directory and start writing JSON schemas

---

**Questions? Check**:
- Full spec: `docs/SPEC-945D-config-hot-reload/spec.md`
- Implementation plan: `docs/SPEC-945D-config-hot-reload/IMPLEMENTATION-PLAN.md`
- Phase 1.1 code: `spec-kit/src/config/loader.rs`
- Local-memory: Search for "SPEC-945D" or "schema validation"
