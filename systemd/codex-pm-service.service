# codex-pm-service — Bot job management service (PM-D5, PM-D6)
#
# Lightweight per-user service that manages bot runs for work items.
# Listens on $XDG_RUNTIME_DIR/codex-pm.sock via JSON-RPC-lite (PM-D7, PM-D8).
#
# Install (socket activation — preferred):
#   mkdir -p ~/.config/systemd/user
#   cp codex-pm-service.{service,socket} ~/.config/systemd/user/
#   systemctl --user daemon-reload
#   systemctl --user enable codex-pm-service.socket   # Enable the SOCKET, not this service
#
# Auto-resume after reboot (enable once):
#   cp codex-pm-resume.{timer,service} ~/.config/systemd/user/
#   systemctl --user daemon-reload
#   systemctl --user enable --now codex-pm-resume.timer
#
# The socket unit starts this service on first connection.
# Combined with exit-when-idle (D135), the service only runs while it has work.
# The resume timer pokes the socket 30s after login so incomplete runs are
# resumed even if no CLI/TUI client connects.
#
# Usage:
#   systemctl --user status codex-pm-service
#   journalctl --user -u codex-pm-service -f

[Unit]
Description=Codex PM Bot Job Management Service
Documentation=https://github.com/anthropics/codex/tree/main/docs/SPEC-PM-003-bot-system
Requires=codex-pm-service.socket
After=codex-pm-service.socket

[Service]
Type=simple
ExecStart=%h/.cargo/bin/codex-pm-service
Restart=on-failure
RestartSec=5

# Environment
Environment=RUST_LOG=info
Environment=XDG_RUNTIME_DIR=%t

# Security hardening
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=read-only
ReadWritePaths=%t %h/.local/share/codex-pm

# Resource limits (lightweight service)
MemoryMax=256M
TasksMax=64

