#!/bin/bash
# Pre-commit hook for policy compliance (SPEC-941, SPEC-KIT-964)
#
# Runs fast policy checks (<5s) to catch violations before commit.
# Can be bypassed with --no-verify for emergencies.
#
# See: codex-rs/MEMORY-POLICY.md, docs/spec-kit/MULTI-AGENT-ARCHITECTURE.md

echo "üîç Running pre-commit checks..."
echo ""

# === Tier-1 anchor: DEV_BRIEF.md required ===
if [[ ! -s "DEV_BRIEF.md" ]]; then
    echo "‚ùå DEV_BRIEF.md is missing or empty"
    echo "Create it before committing. See: scripts/README_doc_lint.md"
    exit 1
fi

# === Session brief: docs/briefs/<branch>.md required on feature branches ===
# One branch = one session. Keep DEV_BRIEF.md stable on main; put session context here.
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || true)
if [[ -n "$BRANCH_NAME" && "$BRANCH_NAME" != "HEAD" && "$BRANCH_NAME" != "main" ]]; then
    SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed -E 's#/+#__#g; s#[^A-Za-z0-9._-]#-#g')
    BRIEF_PATH="docs/briefs/${SAFE_BRANCH_NAME}.md"
    if [[ ! -s "$BRIEF_PATH" ]]; then
        echo "‚ùå Branch brief is missing or empty: $BRIEF_PATH"
        echo ""
        echo "To create the brief, run one of:"
        echo "  code speckit brief init"
        echo "  code speckit brief refresh --query \"<feature keywords>\""
        echo ""
        echo "See: docs/briefs/README.md"
        exit 1
    fi
fi

# === SPEC-KIT-964: Config isolation validation ===
# Always run, regardless of what files changed
if [[ -f "scripts/validate-config-isolation.sh" ]]; then
    if ! bash scripts/validate-config-isolation.sh; then
        echo ""
        echo "‚ùå Config isolation violation detected"
        echo "Fix violations before committing, or skip with: git commit --no-verify"
        exit 1
    fi
fi

# === V6 Doc Contract: Documentation lint (SPEC-KIT-972) ===
# Run doc lint if any .md files or docs/ changed
# NOTE: scripts/doc_lint.py forwards to canonical codex-rs/scripts/doc_lint.py
DOC_CHANGES=$(git diff --cached --name-only | grep -E "\\.md$|^docs/" || true)
if [ -n "$DOC_CHANGES" ]; then
    if [[ -f "scripts/doc_lint.py" ]]; then
        echo ""
        echo "Documentation changes detected, running doc lint..."
        echo "(using canonical: codex-rs/scripts/doc_lint.py)"
        if ! python3 scripts/doc_lint.py; then
            echo ""
            echo "‚ùå Doc lint failed"
            echo "Fix violations before committing, or skip with: git commit --no-verify"
            exit 1
        fi
    fi
fi

# === Priority 3: Instruction file parity validation ===
# Check that CLAUDE.md, AGENTS.md, GEMINI.md are in sync (except header line)
if [[ -f "CLAUDE.md" && -f "AGENTS.md" && -f "GEMINI.md" ]]; then
    echo "Validating instruction file parity..."

    # Compare CLAUDE.md and AGENTS.md (skip first line - header differs)
    if ! diff <(tail -n +2 CLAUDE.md) <(tail -n +2 AGENTS.md) > /dev/null 2>&1; then
        echo "  WARNING: CLAUDE.md and AGENTS.md are out of sync"
        echo "  Files should be identical except for line 1 (header)"
        # Warning only - don't block commit, but inform developer
    fi

    # Compare CLAUDE.md and GEMINI.md (skip first line - header differs)
    if ! diff <(tail -n +2 CLAUDE.md) <(tail -n +2 GEMINI.md) > /dev/null 2>&1; then
        echo "  WARNING: CLAUDE.md and GEMINI.md are out of sync"
        echo "  Files should be identical except for line 1 (header)"
        # Warning only - don't block commit, but inform developer
    fi

    echo "  Instruction file parity check complete"
fi

# === SPEC-941: Policy compliance checks ===
# Only run if spec_kit modules modified
SPEC_KIT_CHANGES=$(git diff --cached --name-only | grep "spec_kit" || true)

if [ -n "$SPEC_KIT_CHANGES" ]; then
    echo ""
    echo "spec_kit changes detected, running policy checks..."

    # Check 1: Storage policy
    if ! bash scripts/validate_storage_policy.sh; then
        echo ""
        echo "‚ùå Storage policy violation detected"
        echo "Fix violations before committing, or skip with: git commit --no-verify"
        exit 1
    fi

    # Check 2: Tag schema
    if ! bash scripts/validate_tag_schema.sh; then
        echo ""
        echo "‚ùå Tag schema violation detected"
        echo "Fix violations before committing, or skip with: git commit --no-verify"
        exit 1
    fi
fi

echo ""
echo "‚úÖ Pre-commit checks passed"
exit 0
