digraph spec_kit_filesystem {
    rankdir=LR;
    node [shape=box, style=rounded, fontname="Arial"];
    edge [fontname="Arial", fontsize=10];

    graph [fontname="Arial", fontsize=14, label="Spec-Kit File System Artifacts\nWhere Everything Lives", labelloc=t];

    // Root
    root [label="/", shape=folder, fillcolor="#E3F2FD", style="filled,bold"];

    // Docs root
    docs [label="docs/", shape=folder, fillcolor="#BBDEFB", style=filled];

    // SPEC directories
    spec_dir [label="SPEC-<ID>-<slug>/\ne.g., SPEC-KIT-069-validate/", shape=folder, fillcolor="#90CAF9", style=filled];

    // SPEC artifacts
    subgraph cluster_spec_artifacts {
        label="SPEC Artifacts (Created by Stages)";
        style=filled;
        fillcolor="#E1F5FE";

        spec_md [label="spec.md\n• Template applied by /speckit.new\n• Core specification", shape=note, fillcolor="#81D4FA", style=filled];
        prd_md [label="PRD.md\n• Created by /speckit.specify\n• Product requirements", shape=note, fillcolor="#81D4FA", style=filled];
        plan_md [label="plan.md\n• Created by /speckit.plan\n• Work breakdown", shape=note, fillcolor="#81D4FA", style=filled];
        tasks_md [label="tasks.md\n• Created by /speckit.tasks\n• Task decomposition\n• Mirrors SPEC.md", shape=note, fillcolor="#81D4FA", style=filled];
    }

    // SPEC.md (task tracker)
    spec_tracker [label="SPEC.md\n• Single source of truth\n• Task tracking table\n• One 'In Progress' at a time", shape=note, fillcolor="#FFE082", style="filled,bold"];

    // Evidence repository
    evidence_root [label="SPEC-OPS-004-integrated-coder-hooks/\nevidence/", shape=folder, fillcolor="#C8E6C9", style=filled];

    subgraph cluster_evidence {
        label="Evidence Repository";
        style=filled;
        fillcolor="#E8F5E9";

        cmd_evidence [label="commands/<SPEC-ID>/\n• Guardrail telemetry\n• <SPEC-ID>_spec-plan_*.json\n• <SPEC-ID>_spec-tasks_*.json\n• HAL validation results", shape=folder, fillcolor="#A5D6A7", style=filled];

        consensus_evidence [label="consensus/<SPEC-ID>/\n• Agent artifacts\n• Synthesis results\n• Conflict records", shape=folder, fillcolor="#A5D6A7", style=filled];

        archive_evidence [label="archive/\n• Baselines\n• Old telemetry\n• Historical runs", shape=folder, fillcolor="#81C784", style=filled];
    }

    // Cost summaries
    cost_dir [label="cost-summaries/<SPEC-ID>/\n• Per-stage costs\n• Agent usage\n• Routing notes", shape=folder, fillcolor="#FFF59D", style=filled];

    // Templates
    templates [label="Templates\n(In Rust code)", shape=folder, fillcolor="#F8BBD0", style=filled];

    subgraph cluster_templates {
        label="Template System";
        style=filled;
        fillcolor="#FCE4EC";

        spec_template [label="spec.md template\ncodex-rs/tui/src/spec_prompts.rs\n• SPEC_TEMPLATE constant\n• Variables: SPEC_ID, description", shape=note, fillcolor="#F48FB1", style=filled];
        prd_template [label="PRD.md template\n• Created by specify stage\n• Multi-agent consensus", shape=note, fillcolor="#F48FB1", style=filled];
    }

    // Prompts
    prompts [label="Prompts\ndocs/spec-kit/prompts.json", shape=note, fillcolor="#CE93D8", style="filled,bold"];

    subgraph cluster_prompts {
        label="Stage Prompts";
        style=filled;
        fillcolor="#F3E5F5";

        prompt_new [label="new_spec\n• Create SPEC structure\n• Generate initial docs", shape=note, fillcolor="#E1BEE7", style=filled];
        prompt_specify [label="specify\n• Draft PRD\n• Requirements analysis", shape=note, fillcolor="#E1BEE7", style=filled];
        prompt_plan [label="plan\n• Work breakdown\n• Risk analysis", shape=note, fillcolor="#E1BEE7", style=filled];
        prompt_tasks [label="tasks\n• Task decomposition\n• Update SPEC.md", shape=note, fillcolor="#E1BEE7", style=filled];
        prompt_implement [label="implement\n• Code generation\n• Quality validation", shape=note, fillcolor="#E1BEE7", style=filled];
        prompt_validate [label="validate\n• Test strategy\n• Validation plan", shape=note, fillcolor="#E1BEE7", style=filled];
    }

    // Guardrail scripts
    scripts [label="scripts/spec_ops_004/", shape=folder, fillcolor="#B2DFDB", style=filled];

    subgraph cluster_scripts {
        label="Guardrail Scripts";
        style=filled;
        fillcolor="#E0F2F1";

        script_plan [label="spec_ops_plan.sh\n• Baseline checks\n• Policy validation\n• HAL optional", shape=note, fillcolor="#80CBC4", style=filled];
        script_tasks [label="spec_ops_tasks.sh\n• Task validation\n• SPEC.md sync", shape=note, fillcolor="#80CBC4", style=filled];
        script_impl [label="spec_ops_implement.sh\n• Pre-implementation checks\n• Lock file validation", shape=note, fillcolor="#80CBC4", style=filled];
        script_val [label="spec_ops_validate.sh\n• Test harness\n• Evidence validation", shape=note, fillcolor="#80CBC4", style=filled];
    }

    // Memory database
    memory_db [label="Local-Memory Database\n~/.local/share/local-memory/\n• Consensus artifacts\n• Agent verdicts\n• Telemetry events", shape=cylinder, fillcolor="#CFD8DC", style="filled,bold"];

    // Main structure
    root -> docs;
    root -> templates;
    root -> scripts;

    docs -> spec_tracker;
    docs -> spec_dir;
    docs -> evidence_root;
    docs -> cost_dir;

    spec_dir -> spec_md;
    spec_dir -> prd_md;
    spec_dir -> plan_md;
    spec_dir -> tasks_md;

    evidence_root -> cmd_evidence;
    evidence_root -> consensus_evidence;
    evidence_root -> archive_evidence;

    templates -> spec_template;
    templates -> prd_template;

    docs -> prompts [style=dashed];
    prompts -> prompt_new;
    prompts -> prompt_specify;
    prompts -> prompt_plan;
    prompts -> prompt_tasks;
    prompts -> prompt_implement;
    prompts -> prompt_validate;

    scripts -> script_plan;
    scripts -> script_tasks;
    scripts -> script_impl;
    scripts -> script_val;

    // External connections
    mcp -> memory_db [style=dotted, label="persists"];

    // Usage annotations
    script_plan -> cmd_evidence [label="writes", color=blue, style=dotted];
    consensus -> consensus_evidence [label="writes", color=blue, style=dotted];
    cost_dir -> filesystem [label="part of", style=invis];

    // Legend
    subgraph cluster_legend {
        label="File Types";
        style=filled;
        fillcolor="#F5F5F5";
        rank=sink;

        leg_template [label="Template (in code)", shape=note, fillcolor="#F48FB1", style=filled];
        leg_created [label="Created by stages", shape=note, fillcolor="#81D4FA", style=filled];
        leg_telemetry [label="Telemetry/Evidence", shape=folder, fillcolor="#A5D6A7", style=filled];
        leg_script [label="Shell script", shape=note, fillcolor="#80CBC4", style=filled];

        leg_template -> leg_created [style=invis];
        leg_created -> leg_telemetry [style=invis];
        leg_telemetry -> leg_script [style=invis];
    }
}
