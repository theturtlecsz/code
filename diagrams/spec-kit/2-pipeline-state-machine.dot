digraph spec_kit_pipeline_v2 {
    rankdir=TB;
    node [shape=box, style=rounded, fontname="Arial"];
    edge [fontname="Arial", fontsize=10];

    graph [fontname="Arial", fontsize=14, label="Spec-Kit Pipeline State Machine v2\nACE-Enhanced, No Retries, Strategic Quality Gates", labelloc=t];

    // Entry
    init [label="/speckit.auto SPEC-ID\n• Validate config\n• Initialize state\n• Enable ACE + quality gates", shape=oval, fillcolor="#E3F2FD", style="filled,rounded"];

    stage_check [label="More\nstages?", shape=diamond, fillcolor="#FFF9C4", style=filled];
    complete [label="Pipeline Complete\n• Finalize quality gates\n• Success message", shape=oval, fillcolor="#C8E6C9", style="filled,rounded"];

    // NEW: ACE Pre-fetch
    ace_prefetch [label="ACE Pre-fetch\n• Get playbook bullets\n• Cache in state\n• Scope: speckit.<stage>", fillcolor="#E1BEE7", style="filled,bold"];

    // Quality gate (strategic placement)
    qg_check [label="Quality Gate\nCheckpoint?", shape=diamond, fillcolor="#FFE082", style=filled];
    qg_execute [label="Execute Quality Gate\n• BeforeSpecify: Clarify\n• AfterSpecify: Checklist\n• AfterTasks: Analyze\n• Spawn 3 agents\n• ACE-enhanced resolution", fillcolor="#FFCCBC", style=filled];
    qg_process [label="Process Issues\n• Auto-resolve (55%→70% with ACE)\n• GPT-5 validate (35%)\n• Escalate (5-10%)", fillcolor="#FFAB91", style=filled];
    qg_human [label="Human\nDecision", shape=parallelogram, fillcolor="#FF8A65", style=filled];
    qg_done [label="Quality Gate\nComplete", fillcolor="#C5E1A5", style=filled];

    // Guardrail phase
    guardrail [label="Phase: Guardrail\n• Execute shell script\n• Validate policy\n• Write telemetry", fillcolor="#B3E5FC", style=filled];
    guardrail_check [label="Guardrail\nPassed?", shape=diamond, fillcolor="#FFE082", style=filled];
    guardrail_fail [label="Halt: Guardrail Failed\n• Show error\n• Manual fix required", shape=oval, fillcolor="#FFCDD2", style="filled,rounded"];

    // Agent execution phase
    agents_phase [label="Phase: ExecutingAgents\n• Build prompt with ACE bullets\n• Apply ACE routing\n• Spawn agents", fillcolor="#C5CAE9", style=filled];
    prompt_build [label="Build Prompt\n• Load artifacts\n• Inject ACE bullets\n• Add agent instructions", fillcolor="#9FA8DA", style=filled];
    spawn_agents [label="Spawn Agents\n• Gemini, Claude, GPT-Pro\n• [+GPT-Codex if Tier 3]\n• Parallel execution", fillcolor="#7986CB", style=filled];
    agents_wait [label="Wait for\nCompletion", shape=parallelogram, fillcolor="#5C6BC0", style=filled];
    agents_check [label="All agents\ncompleted?", shape=diamond, fillcolor="#FFE082", style=filled];
    agents_degrade [label="Degraded Mode\n• 2/3 consensus acceptable\n• Schedule follow-up checklist\n• Continue pipeline", fillcolor="#FFF9C4", style=filled];

    // Consensus phase
    consensus_phase [label="Phase: CheckingConsensus\n• Query local-memory\n• Synthesize results\n• Validate agreement", fillcolor="#A5D6A7", style=filled];
    consensus_check [label="Consensus\nOK?", shape=diamond, fillcolor="#FFE082", style=filled];
    consensus_degrade [label="Degraded Consensus\n• 2/3 majority\n• Schedule checklist\n• Continue", fillcolor="#FFF9C4", style=filled];
    consensus_fail [label="Halt: Consensus Failed\n• Show conflicts\n• Manual resolution", shape=oval, fillcolor="#FFCDD2", style="filled,rounded"];

    // ACE Learning
    ace_feedback [label="ACE Learning\n• Send feedback\n• Update playbook\n• Improve for next run", fillcolor="#E1BEE7", style="filled,bold"];

    // Stage advancement
    advance [label="Advance Stage\n• Clear ACE cache\n• Persist costs\n• Next stage index", fillcolor="#B2DFDB", style=filled];

    // Special: Validate halt
    validate_check [label="Stage ==\nValidate?", shape=diamond, fillcolor="#FFE082", style=filled];
    validate_fail [label="Halt: Validation Failed\n• Manual review required\n• Fix tests/implementation", shape=oval, fillcolor="#FFCDD2", style="filled,rounded"];

    // Main flow
    init -> stage_check;
    stage_check -> complete [label="No"];
    stage_check -> ace_prefetch [label="Yes"];

    ace_prefetch -> qg_check;
    qg_check -> qg_execute [label="Yes"];
    qg_check -> guardrail [label="No"];

    qg_execute -> qg_process;
    qg_process -> qg_done [label="Auto-resolved\n(55-70%)"];
    qg_process -> qg_human [label="Escalated\n(5-10%)"];
    qg_human -> qg_done;
    qg_done -> guardrail;

    guardrail -> guardrail_check;
    guardrail_check -> agents_phase [label="Passed"];
    guardrail_check -> guardrail_fail [label="Failed"];

    agents_phase -> prompt_build;
    prompt_build -> spawn_agents;
    spawn_agents -> agents_wait;
    agents_wait -> agents_check;

    agents_check -> consensus_phase [label="All OK"];
    agents_check -> agents_degrade [label="Failures"];
    agents_degrade -> consensus_phase;

    consensus_phase -> consensus_check;
    consensus_check -> validate_check [label="Consensus OK"];
    consensus_check -> consensus_degrade [label="Degraded\n(2/3)"];
    consensus_check -> consensus_fail [label="Failed\n(<2/3)"];

    consensus_degrade -> validate_check;

    validate_check -> ace_feedback [label="Other stages"];
    validate_check -> validate_fail [label="Validate\n+ failed"];

    ace_feedback -> advance;
    advance -> stage_check;

    // Legend
    subgraph cluster_legend {
        label="Pipeline v2 Changes";
        style=filled;
        fillcolor="#F5F5F5";

        leg_ace [label="NEW: ACE Integration", fillcolor="#E1BEE7", style="filled,bold"];
        leg_quality [label="Strategic Quality Gates", fillcolor="#FFCCBC", style=filled];
        leg_degrade [label="Degraded Mode (no retries)", fillcolor="#FFF9C4", style=filled];
        leg_halt [label="Halt Points", fillcolor="#FFCDD2", style="filled,rounded"];

        leg_ace -> leg_quality [style=invis];
        leg_quality -> leg_degrade [style=invis];
        leg_degrade -> leg_halt [style=invis];
    }
}
