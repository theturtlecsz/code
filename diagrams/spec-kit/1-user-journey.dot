digraph spec_kit_user_journey {
    rankdir=TB;
    node [shape=box, style=rounded, fontname="Arial"];
    edge [fontname="Arial"];

    // Styling
    graph [fontname="Arial", fontsize=14, label="Spec-Kit User Journey\nHigh-Level Command Flow", labelloc=t];

    // User commands
    user [label="/speckit.new <description>", shape=oval, fillcolor="#E3F2FD", style="filled,rounded"];

    // Entry point
    new_spec [label="Create SPEC\n• Generate SPEC-ID\n• Create directory\n• Apply templates", fillcolor="#FFE082", style=filled];

    // Quality commands (optional)
    quality [label="Quality Commands\n(Optional)", shape=diamond, fillcolor="#FFF9C4", style=filled];
    clarify [label="/speckit.clarify\n• Identify ambiguities\n• Suggest clarifications", fillcolor="#C5E1A5", style=filled];
    analyze [label="/speckit.analyze\n• Cross-artifact consistency\n• Auto-fix issues", fillcolor="#C5E1A5", style=filled];
    checklist [label="/speckit.checklist\n• Requirement scoring\n• Quality metrics", fillcolor="#C5E1A5", style=filled];

    // Main automation
    auto [label="/speckit.auto\n• Full 6-stage pipeline\n• ACE-enhanced\n• Optimized models (flashlite+haiku)\n• ~75 min, ~$6.50", fillcolor="#FF8A65", style=filled];

    // Stage progression
    plan [label="Stage 1: Plan\n• Quality: Clarify (ambiguities)\n• Guardrail validation\n• ACE + 3 agents (gemini+claude+gpt_pro)\n• Consensus check\n~18 min, ~$1.30", fillcolor="#90CAF9", style=filled];
    tasks [label="Stage 2: Tasks\n• Quality: Checklist (claude+code only)\n• Guardrail validation\n• ACE + 3 agents (gemini+claude+gpt_pro)\n• Consensus check\n~16 min, ~$1.35", fillcolor="#90CAF9", style=filled];
    implement [label="Stage 3: Implement\n• Quality: Analyze (consistency)\n• Guardrail validation\n• ACE + 4 agents (pro+opus+codex+gpt_pro)\n• Consensus check\n~23 min, ~$2.80", fillcolor="#90CAF9", style=filled];
    validate [label="Stage 4: Validate\n• Test strategy\n• Validation plan\n• Consensus check\n~10 min, ~$1", fillcolor="#90CAF9", style=filled];
    audit [label="Stage 5: Audit\n• Compliance checks\n• Security review\n• Consensus check\n~10 min, ~$1", fillcolor="#90CAF9", style=filled];
    unlock [label="Stage 6: Unlock\n• Final approval\n• Ready for merge\n• Consensus check\n~10 min, ~$1", fillcolor="#90CAF9", style=filled];

    // Outputs
    artifacts [label="Artifacts Created\n• docs/SPEC-<ID>-<slug>/\n  - spec.md, PRD.md\n  - plan.md, tasks.md\n• SPEC.md updated\n• Evidence telemetry", shape=folder, fillcolor="#C8E6C9", style=filled];

    status [label="/speckit.status\nNative Dashboard\n• Stage progress\n• Evidence health\n• Warnings", shape=oval, fillcolor="#B2DFDB", style=filled];

    // Flow
    user -> new_spec;
    new_spec -> quality [label="Optional"];
    new_spec -> auto [label="Direct"];

    quality -> clarify [label="Ambiguous"];
    quality -> analyze [label="Inconsistent"];
    quality -> checklist [label="Quality Check"];
    clarify -> auto;
    analyze -> auto;
    checklist -> auto;

    auto -> plan;
    plan -> tasks [label="✓ Consensus"];
    tasks -> implement [label="✓ Consensus"];
    implement -> validate [label="✓ Consensus"];
    validate -> audit [label="✓ Consensus"];
    audit -> unlock [label="✓ Consensus"];
    unlock -> artifacts [label="✓ Complete"];

    // Status monitoring
    user -> status [style=dashed, label="Monitor"];
    plan -> status [style=dotted];
    tasks -> status [style=dotted];
    implement -> status [style=dotted];
    validate -> status [style=dotted];
    audit -> status [style=dotted];
    unlock -> status [style=dotted];

    // Degraded mode paths
    plan -> tasks [label="Degraded\n(2/3 consensus)", style=dashed, color=orange];
    tasks -> implement [label="Degraded", style=dashed, color=orange];
    validate -> artifacts [label="Failed:\nManual review", style=dashed, color=red];

    // Legend
    subgraph cluster_legend {
        label="Legend";
        style=filled;
        fillcolor="#FAFAFA";

        leg_cmd [label="User Command", shape=oval, fillcolor="#E3F2FD", style="filled,rounded"];
        leg_stage [label="Pipeline Stage", fillcolor="#90CAF9", style=filled];
        leg_output [label="Output/Artifact", shape=folder, fillcolor="#C8E6C9", style=filled];
        leg_optional [label="Optional Step", fillcolor="#C5E1A5", style=filled];

        leg_cmd -> leg_stage [style=invis];
        leg_stage -> leg_output [style=invis];
        leg_output -> leg_optional [style=invis];
    }
}
